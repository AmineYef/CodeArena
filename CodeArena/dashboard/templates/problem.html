<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probl√®me {{ problem_number }} - CodeArena</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Styles pour le markdown */
        .problem-content h1 {
            font-size: 2rem;
            color: #667eea;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        
        .problem-content h2 {
            font-size: 1.5rem;
            color: #667eea;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        .problem-content p {
            margin: 1rem 0;
            line-height: 1.8;
        }
        
        .problem-content ul, .problem-content ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }
        
        .problem-content li {
            margin: 0.5rem 0;
        }
        
        .problem-content code {
            background: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }
        
        .problem-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .problem-content pre code {
            background: transparent;
            color: inherit;
            padding: 0;
        }
        
        .problem-content strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .problem-content em {
            color: #666;
            font-style: italic;
        }
        
        .verdict-box {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: bold;
            display: none;
        }
        .verdict-ok {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }
        .verdict-wrong {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }
        .verdict-timeout {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }
        .verdict-error {
            background: #fee;
            border: 2px solid #f00;
            color: #c00;
        }
        .verdict-pending {
            background: #e7f3ff;
            border: 2px solid #0066cc;
            color: #004085;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">üèÜ CodeArena</h1>
            <ul class="nav-links">
                <li><a href="/contest/{{ contest_id }}/dashboard?username={{ username }}">Retour au Contest</a></li>
                <li><a href="/contest/{{ contest_id }}/leaderboard">Leaderboard</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="problem-layout">
            <!-- Colonne gauche : √ânonc√© -->
            <div class="problem-statement">
                <div class="problem-header">
                    <h1>Probl√®me {{ problem_number }}</h1>
                    <span class="badge badge-{{ meta.difficulty }}">{{ meta.difficulty }}</span>
                </div>

                <div class="problem-content">
                    {{ statement | markdown | safe }}
                </div>
            </div>

            <!-- Colonne droite : √âditeur de code -->
            <div class="code-editor-panel">
                <div class="editor-header">
                    <label for="language">Langage :</label>
                    <select id="language" name="language">
                        <option value="python">Python</option>
                        <option value="cpp">C++</option>
                        <option value="java">Java</option>
                    </select>
                </div>

                <textarea id="code-editor" class="code-editor" placeholder="// √âcrivez votre code ici..."></textarea>

                <div class="editor-actions">
                    <button id="submit-btn" class="btn btn-primary">üì§ Soumettre</button>
                    <button id="clear-btn" class="btn btn-secondary">üóëÔ∏è Effacer</button>
                </div>

                <div id="verdict-box" class="verdict-box"></div>
            </div>
        </div>
    </div>

    <script>
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const codeEditor = document.getElementById('code-editor');
        const languageSelect = document.getElementById('language');
        const verdictBox = document.getElementById('verdict-box');

        let currentSubmissionId = null;

        submitBtn.addEventListener('click', async () => {
            const code = codeEditor.value.trim();
            if (!code) {
                alert('‚ö†Ô∏è Veuillez √©crire du code avant de soumettre.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Envoi en cours...';

            // Afficher le statut "en cours"
            verdictBox.style.display = 'block';
            verdictBox.className = 'verdict-box verdict-pending';
            verdictBox.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="animation: spin 1s linear infinite;">‚è≥</div>
                    <div>
                        <strong>Soumission en cours d'√©valuation...</strong><br>
                        <small>Veuillez patienter quelques secondes</small>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: '{{ username }}',
                        problem_id: '{{ problem_id }}',
                        language: languageSelect.value,
                        code: code,
                        contest_id: '{{ contest_id }}'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentSubmissionId = data.submission_id;
                    
                    // Attendre le verdict
                    checkVerdict();
                } else {
                    showError(data.error || 'Erreur inconnue');
                }
            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'üì§ Soumettre';
        });

        async function checkVerdict() {
            if (!currentSubmissionId) return;

            try {
                const response = await fetch(`/api/submission/${currentSubmissionId}/status`);
                const data = await response.json();

                if (data.status === 'pending') {
                    // R√©essayer apr√®s 1 seconde
                    setTimeout(checkVerdict, 1000);
                } else {
                    // Afficher le verdict final
                    displayVerdict(data.verdict || data.status);
                }
            } catch (error) {
                console.error('Erreur:', error);
                setTimeout(checkVerdict, 1000);
            }
        }

        function displayVerdict(verdict) {
            verdictBox.style.display = 'block';

            const verdictMessages = {
                'OK': {
                    className: 'verdict-ok',
                    icon: '‚úÖ',
                    title: 'Accept√© !',
                    message: 'Votre solution est correcte. +100 points'
                },
                'WRONG_ANSWER': {
                    className: 'verdict-wrong',
                    icon: '‚ùå',
                    title: 'Mauvaise R√©ponse',
                    message: 'Votre solution ne produit pas la bonne sortie. -10 points'
                },
                'TIMEOUT': {
                    className: 'verdict-timeout',
                    icon: '‚è±Ô∏è',
                    title: 'Temps D√©pass√©',
                    message: 'Votre programme prend trop de temps. -20 points'
                },
                'RUNTIME_ERROR': {
                    className: 'verdict-error',
                    icon: 'üí•',
                    title: 'Erreur d\'Ex√©cution',
                    message: 'Votre programme a plant√©. -10 points'
                },
                'COMPILATION_ERROR': {
                    className: 'verdict-error',
                    icon: 'üîß',
                    title: 'Erreur de Compilation',
                    message: 'Votre code ne compile pas. -5 points'
                }
            };

            const info = verdictMessages[verdict] || {
                className: 'verdict-error',
                icon: '‚ùì',
                title: 'Erreur',
                message: verdict
            };

            verdictBox.className = 'verdict-box ' + info.className;
            verdictBox.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 3rem;">${info.icon}</div>
                    <div>
                        <strong style="font-size: 1.2rem;">${info.title}</strong><br>
                        <span>${info.message}</span>
                    </div>
                </div>
            `;

            // Notifier l'utilisateur
            if (verdict === 'OK') {
                setTimeout(() => {
                    if (confirm('‚úÖ Probl√®me r√©solu ! Voulez-vous retourner au dashboard ?')) {
                        window.location.href = '/contest/{{ contest_id }}/dashboard?username={{ username }}';
                    }
                }, 1500);
            }
        }

        function showError(message) {
            verdictBox.style.display = 'block';
            verdictBox.className = 'verdict-box verdict-error';
            verdictBox.innerHTML = `
                <strong>‚ùå Erreur</strong><br>
                ${message}
            `;
        }

        clearBtn.addEventListener('click', () => {
            if (confirm('üóëÔ∏è Effacer tout le code ?')) {
                codeEditor.value = '';
                verdictBox.style.display = 'none';
            }
        });

        // Animation de rotation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>